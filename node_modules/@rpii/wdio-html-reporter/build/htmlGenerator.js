"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

const Handlebars = require('handlebars');

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const encode = require('./encode').default;

const moment = require('moment');

const logger = require('@log4js-node/log4js-api');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

class HtmlGenerator {
  static htmlOutput(reportOptions, callback = () => {}) {
    try {
      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation started");
      }

      let templateFile = fs.readFileSync(reportOptions.templateFilename, 'utf8');
      Handlebars.registerHelper('imageAsBase64', function (screenshotFile, screenshotPath, hbopts) {
        // occurs when there is an error file
        if (!fs.existsSync(screenshotFile)) {
          if (screenshotPath) {
            screenshotFile = `${screenshotPath}/${screenshotFile}`;
          } else {
            screenshotFile = `${screenshotFile}`;
          }
        }

        return encode(path.resolve(screenshotFile));
      });
      Handlebars.registerHelper('isValidReport', function (suites, hbopts) {
        if (suites && suites.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('isValidSuite', function (suite, hbopts) {
        if (suite.title.length > 0 && suite.type === 'suite' && suite.tests.length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('testStateColour', function (state, hbopts) {
        if (state === 'passed') {
          return 'test-pass';
        } else if (state === 'failed') {
          return 'test-fail';
        } else if (state === 'pending') {
          return 'test-pending';
        } else if (state === 'skipped') {
          return 'test-skipped';
        }
      });
      Handlebars.registerHelper('testStateIcon', function (state, hbopts) {
        if (state === 'passed') {
          return '<span class="success">&#10004;</span>';
        } else if (state === 'failed') {
          return '<span class="error">&#10006;</span>';
        } else if (state === 'pending') {
          return '<span class="pending">&#10004;</span>';
        } else if (state === 'skipped') {
          return '<span class="skipped">&#10034;</span>';
        }
      });
      Handlebars.registerHelper('suiteStateColour', function (tests, hbopts) {
        let numTests = Object.keys(tests).length;

        _.values(tests).find(test => {
          if (test.state === "pending") {
            --numTests;
          }
        });

        let fail = _.values(tests).find(test => {
          return test.state === 'failed';
        });

        if (fail != null) {
          return 'suite-fail';
        }

        let passes = _.values(tests).filter(test => {
          return test.state === 'passed';
        });

        if (passes.length === numTests && numTests > 0) {
          return 'suite-pass';
        } //skipped is the lowest priority check


        let skipped = _.values(tests).find(test => {
          return test.state === 'skipped';
        });

        if (skipped != null) {
          return 'suite-pending';
        }

        return 'suite-unknown';
      });
      Handlebars.registerHelper('humanizeDuration', function (duration, hbopts) {
        return moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
          trim: false
        });
      });
      Handlebars.registerHelper('ifSuiteHasTests', function (testsHash, hbopts) {
        if (Object.keys(testsHash).length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsError', function (event, hbopts) {
        if (event.type.includes('Error')) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsScreenshot', function (event, hbopts) {
        if (event.type === 'screenshot') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsLogMessage', function (event, hbopts) {
        if (event.type === 'log') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifCollapseTests', function (text, hbopts) {
        return reportOptions.collapseTests;
      });
      Handlebars.registerHelper('logClass', function (text, hbopts) {
        if (text.includes('Test Iteration')) {
          return "test-iteration";
        } else {
          return "log-output";
        }
      });
      Object.keys(reportOptions.templateFuncs).forEach(key => {
        Handlebars.registerHelper(key, reportOptions.templateFuncs[key]);
      });

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        let jsonFile = reportOptions.reportFile.replace('.html', '.json');
        fs.outputFileSync(jsonFile, JSON.stringify(reportOptions.data));
      }

      let template = Handlebars.compile(templateFile);
      let html = template(reportOptions.data);

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        fs.outputFileSync(reportOptions.reportFile, html);
      }

      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation completed");
      }

      callback(true);
    } catch (ex) {
      if (reportOptions.LOG) {
        reportOptions.LOG.error("Html Generation processing ended in error: " + ex);
      }

      callback(false);
    }
  }

}

var _default = HtmlGenerator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odG1sR2VuZXJhdG9yLmpzIl0sIm5hbWVzIjpbIkhhbmRsZWJhcnMiLCJyZXF1aXJlIiwiZnMiLCJfIiwicGF0aCIsImVuY29kZSIsImRlZmF1bHQiLCJtb21lbnQiLCJsb2dnZXIiLCJtb21lbnREdXJhdGlvbkZvcm1hdFNldHVwIiwiSHRtbEdlbmVyYXRvciIsImh0bWxPdXRwdXQiLCJyZXBvcnRPcHRpb25zIiwiY2FsbGJhY2siLCJMT0ciLCJkZWJ1ZyIsInRlbXBsYXRlRmlsZSIsInJlYWRGaWxlU3luYyIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZWdpc3RlckhlbHBlciIsInNjcmVlbnNob3RGaWxlIiwic2NyZWVuc2hvdFBhdGgiLCJoYm9wdHMiLCJleGlzdHNTeW5jIiwicmVzb2x2ZSIsInN1aXRlcyIsImxlbmd0aCIsImZuIiwiaW52ZXJzZSIsInN1aXRlIiwidGl0bGUiLCJ0eXBlIiwidGVzdHMiLCJzdGF0ZSIsIm51bVRlc3RzIiwiT2JqZWN0Iiwia2V5cyIsInZhbHVlcyIsImZpbmQiLCJ0ZXN0IiwiZmFpbCIsInBhc3NlcyIsImZpbHRlciIsInNraXBwZWQiLCJkdXJhdGlvbiIsImZvcm1hdCIsInRyaW0iLCJ0ZXN0c0hhc2giLCJldmVudCIsImluY2x1ZGVzIiwidGV4dCIsImNvbGxhcHNlVGVzdHMiLCJ0ZW1wbGF0ZUZ1bmNzIiwiZm9yRWFjaCIsImtleSIsInBhdGhFeGlzdHNTeW5jIiwib3V0cHV0RGlyIiwianNvbkZpbGUiLCJyZXBvcnRGaWxlIiwicmVwbGFjZSIsIm91dHB1dEZpbGVTeW5jIiwiSlNPTiIsInN0cmluZ2lmeSIsImRhdGEiLCJ0ZW1wbGF0ZSIsImNvbXBpbGUiLCJodG1sIiwiZXgiLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQ0EsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUMsWUFBRCxDQUExQjs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxVQUFELENBQWxCOztBQUNBLE1B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QUNILEtBMUpELENBMEpFLE9BQU1zRCxFQUFOLEVBQVU7QUFDUixVQUFJdkQsYUFBYSxDQUFDRSxHQUFsQixFQUF1QjtBQUNuQkYsUUFBQUEsYUFBYSxDQUFDRSxHQUFkLENBQWtCc0QsS0FBbEIsQ0FBd0IsZ0RBQWdERCxFQUF4RTtBQUNIOztBQUNEdEQsTUFBQUEsUUFBUSxDQUFDLEtBQUQsQ0FBUjtBQUNIO0FBQ0o7O0FBbktnQjs7ZUFzS05ILGEiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuY29uc3QgSGFuZGxlYmFycyA9IHJlcXVpcmUoJ2hhbmRsZWJhcnMnKTtcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xyXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IGVuY29kZSA9IHJlcXVpcmUoJy4vZW5jb2RlJykuZGVmYXVsdDtcclxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ0Bsb2c0anMtbm9kZS9sb2c0anMtYXBpJyk7XHJcblxyXG5jb25zdCBtb21lbnREdXJhdGlvbkZvcm1hdFNldHVwID0gcmVxdWlyZShcIm1vbWVudC1kdXJhdGlvbi1mb3JtYXRcIik7XHJcbm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAobW9tZW50KTtcclxuXHJcbmNsYXNzIEh0bWxHZW5lcmF0b3IgIHtcclxuXHJcbiAgICBzdGF0aWMgaHRtbE91dHB1dChyZXBvcnRPcHRpb25zLCBjYWxsYmFjayA9ICgpID0+e30pIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmRlYnVnKFwiSHRtbCBHZW5lcmF0aW9uIHN0YXJ0ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyhyZXBvcnRPcHRpb25zLnRlbXBsYXRlRmlsZW5hbWUsICd1dGY4Jyk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpbWFnZUFzQmFzZTY0JywgZnVuY3Rpb24gKHNjcmVlbnNob3RGaWxlLCBzY3JlZW5zaG90UGF0aCwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBvY2N1cnMgd2hlbiB0aGVyZSBpcyBhbiBlcnJvciBmaWxlXHJcbiAgICAgICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoc2NyZWVuc2hvdEZpbGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbnNob3RQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbnNob3RGaWxlID0gYCR7c2NyZWVuc2hvdFBhdGh9LyR7c2NyZWVuc2hvdEZpbGV9YDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5zaG90RmlsZSA9IGAke3NjcmVlbnNob3RGaWxlfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGVuY29kZShwYXRoLnJlc29sdmUoc2NyZWVuc2hvdEZpbGUpKSA7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaXNWYWxpZFJlcG9ydCcsIGZ1bmN0aW9uIChzdWl0ZXMsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN1aXRlcyAmJiBzdWl0ZXMubGVuZ3RoID4gMCApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaXNWYWxpZFN1aXRlJywgZnVuY3Rpb24gKHN1aXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdWl0ZS50aXRsZS5sZW5ndGggPiAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc3VpdGUudHlwZSA9PT0gJ3N1aXRlJyAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHN1aXRlLnRlc3RzLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZXN0U3RhdGVDb2xvdXInLCBmdW5jdGlvbiAoc3RhdGUsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlID09PSAncGFzc2VkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1wYXNzJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdmYWlsZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LWZhaWwnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3BlbmRpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LXBlbmRpbmcnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3NraXBwZWQnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3Rlc3Qtc2tpcHBlZCc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZXN0U3RhdGVJY29uJywgZnVuY3Rpb24gKHN0YXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gJ3Bhc3NlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwic3VjY2Vzc1wiPiYjMTAwMDQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ2ZhaWxlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwiZXJyb3JcIj4mIzEwMDA2Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdwZW5kaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJwZW5kaW5nXCI+JiMxMDAwNDs8L3NwYW4+JyA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnc2tpcHBlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwic2tpcHBlZFwiPiYjMTAwMzQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3N1aXRlU3RhdGVDb2xvdXInLCBmdW5jdGlvbiAodGVzdHMsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgbGV0IG51bVRlc3RzID0gT2JqZWN0LmtleXModGVzdHMpLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgICAgICBfLnZhbHVlcyh0ZXN0cykuZmluZCgodGVzdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBpZiAodGVzdC5zdGF0ZSA9PT0gXCJwZW5kaW5nXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAtLW51bVRlc3RzO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgZmFpbCA9IF8udmFsdWVzKHRlc3RzKS5maW5kKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdmYWlsZWQnO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGlmIChmYWlsICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLWZhaWwnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGxldCBwYXNzZXMgPSBfLnZhbHVlcyh0ZXN0cykuZmlsdGVyKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdwYXNzZWQnO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGlmIChwYXNzZXMubGVuZ3RoID09PSBudW1UZXN0cyAmJiBudW1UZXN0cyA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLXBhc3MnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vc2tpcHBlZCBpcyB0aGUgbG93ZXN0IHByaW9yaXR5IGNoZWNrXHJcbiAgICAgICAgICAgICAgICBsZXQgc2tpcHBlZCA9IF8udmFsdWVzKHRlc3RzKS5maW5kKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdza2lwcGVkJztcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBpZiAoc2tpcHBlZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS1wZW5kaW5nJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLXVua25vd24nXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaHVtYW5pemVEdXJhdGlvbicsIGZ1bmN0aW9uIChkdXJhdGlvbiwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9tZW50LmR1cmF0aW9uKGR1cmF0aW9uLCBcIm1pbGxpc2Vjb25kc1wiKS5mb3JtYXQoJ2hoOm1tOnNzLlNTJywge3RyaW06IGZhbHNlfSlcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZlN1aXRlSGFzVGVzdHMnLCBmdW5jdGlvbiAodGVzdHNIYXNoLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyh0ZXN0c0hhc2gpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmRXZlbnRJc0Vycm9yJywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlLmluY2x1ZGVzKCdFcnJvcicpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkV2ZW50SXNTY3JlZW5zaG90JywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAnc2NyZWVuc2hvdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmRXZlbnRJc0xvZ01lc3NhZ2UnLCBmdW5jdGlvbiAoZXZlbnQsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICdsb2cnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkNvbGxhcHNlVGVzdHMnLCBmdW5jdGlvbiAodGV4dCAsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcG9ydE9wdGlvbnMuY29sbGFwc2VUZXN0cztcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2dDbGFzcycsIGZ1bmN0aW9uICh0ZXh0ICwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGV4dC5pbmNsdWRlcygnVGVzdCBJdGVyYXRpb24nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcInRlc3QtaXRlcmF0aW9uXCI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcImxvZy1vdXRwdXRcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHJlcG9ydE9wdGlvbnMudGVtcGxhdGVGdW5jcykuZm9yRWFjaCgoa2V5KT0+e1xyXG4gICAgICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcihrZXksIHJlcG9ydE9wdGlvbnMudGVtcGxhdGVGdW5jc1trZXldKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoZnMucGF0aEV4aXN0c1N5bmMocmVwb3J0T3B0aW9ucy5vdXRwdXREaXIpKSB7XHJcbiAgICAgICAgICAgICAgIGxldCBqc29uRmlsZSA9IHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZS5yZXBsYWNlKCcuaHRtbCcgLCAnLmpzb24nKSA7XHJcbiAgICAgICAgICAgICAgICAgICAgZnMub3V0cHV0RmlsZVN5bmMoanNvbkZpbGUsIEpTT04uc3RyaW5naWZ5KHJlcG9ydE9wdGlvbnMuZGF0YSkpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgdGVtcGxhdGUgPSBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGVGaWxlKTtcclxuICAgICAgICAgICAgbGV0IGh0bWwgPSB0ZW1wbGF0ZShyZXBvcnRPcHRpb25zLmRhdGEpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGZzLnBhdGhFeGlzdHNTeW5jKHJlcG9ydE9wdGlvbnMub3V0cHV0RGlyKSkge1xyXG4gICAgICAgICAgICAgICAgZnMub3V0cHV0RmlsZVN5bmMocmVwb3J0T3B0aW9ucy5yZXBvcnRGaWxlLCBodG1sKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmRlYnVnKFwiSHRtbCBHZW5lcmF0aW9uIGNvbXBsZXRlZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYWxsYmFjayh0cnVlKTtcclxuICAgICAgICB9IGNhdGNoKGV4KSB7XHJcbiAgICAgICAgICAgIGlmIChyZXBvcnRPcHRpb25zLkxPRykge1xyXG4gICAgICAgICAgICAgICAgcmVwb3J0T3B0aW9ucy5MT0cuZXJyb3IoXCJIdG1sIEdlbmVyYXRpb24gcHJvY2Vzc2luZyBlbmRlZCBpbiBlcnJvcjogXCIgKyBleCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgSHRtbEdlbmVyYXRvcjtcclxuIl19