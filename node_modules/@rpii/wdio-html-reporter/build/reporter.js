"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _reporter = _interopRequireDefault(require("@wdio/reporter"));

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

const log4js = require('@log4js-node/log4js-api');

const logger = log4js.getLogger('default');

const ReportEvents = require("@rpii/wdio-report-events");

let proxy = new ReportEvents.default();

class HtmlReporter extends _reporter.default {
  constructor(opts) {
    opts = Object.assign({}, {
      stdout: true,
      outputDir: 'reports/html-reports/',
      filename: 'report.html',
      templateFilename: path.resolve(__dirname, '../templates/wdio-html-reporter-template.hbs'),
      templateFuncs: {},
      reportTitle: 'Test Report Title',
      showInBrowser: false,
      collapseTests: false,
      useOnAfterCommandForScreenshot: true,
      logFile: "logs/reporter.log",
      LOG: null
    }, opts);
    super(opts);
    this.options = opts;

    if (!this.options.LOG) {
      this.options.LOG = logger;
    }

    const dir = this.options.outputDir + 'screenshots';
    fs.ensureDirSync(dir);
    this.suiteUids = [];
    this.suites = [];
    this.indents = 0;
    this.suiteIndents = {};
    this.metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: 0,
      end: 0,
      duration: 0
    };
    this.openInProgress = false;
    this.defaultTestIndent = '   ';
    proxy.connectMessageEvent(this.saveMessage.bind(this));
    proxy.connectScreenshotEvent(this.saveScreenshot.bind(this));
  }

  get isSynchronised() {
    return !this.openInProgress;
  }

  onRunnerStart(runner) {
    this.log("onRunnerStart: ", JSON.stringify(runner)); //todo look at fix, not async safe. but one cid per report file

    this.cid = runner.cid;
    this.metrics.passed = 0;
    this.metrics.skipped = 0;
    this.metrics.failed = 0;
  }

  onSuiteStart(suite) {
    this.suiteUids.push(suite.uid);
    this.suiteIndents[suite.uid] = ++this.indents;
    this.suiteUid = suite.uid;
    let thisSuite = Object.assign({}, suite);
    thisSuite.type = 'suite';
    this.suites.push(thisSuite);
    this.log("onSuiteStart: ", JSON.stringify(thisSuite));
  }

  onTestStart(theTest) {
    this.log("onTestStart: ", JSON.stringify(theTest));
    this.testUid = theTest.uid;
    let test = this.getTest(theTest.uid);
    test.events = [];
    test.errorIndex = 0;
  }

  onTestPass(test) {
    this.log("onTestPass: ", JSON.stringify(test));
    this.metrics.passed++;
  }

  onTestSkip(test) {
    this.log("onTestSkip: ", JSON.stringify(test));
    this.metrics.skipped++;
  }

  onTestFail(test) {
    this.log("onTestFail: ", JSON.stringify(test));
    this.moveErrorsToEvents(test);
    this.metrics.failed++;
  }

  onHookEnd(hook) {
    if (hook.error) {
      this.metrics.failed++;
    }
  }

  onTestEnd(theTest) {
    this.log("onTestEnd: ", JSON.stringify(theTest));
    let test = this.getTest(theTest.uid);
    this.moveErrorsToEvents(test);
  }

  onSuiteEnd(suite) {
    this.log("onSuiteEnd: ", JSON.stringify(suite));
    this.indents--; // this is to display suite end time and duration in master report.

    for (const tsuite of this.suites) {
      if (tsuite.uid == suite.uid) {
        tsuite.end = suite.end;
        tsuite._duration = suite._duration;
        break;
      }
    }
  }

  isScreenshotCommand(command) {
    const isScreenshotEndpoint = /\/session\/[^/]*\/screenshot/;
    return isScreenshotEndpoint.test(command.endpoint);
  } //this is a hack to get around lack of onScreenshot event


  onAfterCommand(command) {
    if (this.options.useOnAfterCommandForScreenshot) {
      if (this.isScreenshotCommand(command) && command.result.value) {
        const timestamp = moment().format('YYYYMMDD-HHmmss.SSS');
        const filepath = path.join(this.options.outputDir, '/screenshots/', encodeURIComponent(this.cid), timestamp, this.options.filename + '.png');
        this.log("onAfterCommand: taking screenshot " + filepath);
        fs.outputFileSync(filepath, Buffer.from(command.result.value, 'base64'));
        let test = this.getTest(this.testUid);
        test.events.push({
          type: 'screenshot',
          value: filepath
        });
      }
    }
  }

  log(message, object) {
    if (this.options.LOG || this.options.debug) {
      this.options.LOG.debug(message + object);
    }
  }

  getSuite(uid) {
    for (let i = 0; i < this.suites.length; i++) {
      if (uid === this.suites[i].uid) {
        return this.suites[i];
      }
    }

    return null;
  }

  getTest(uid) {
    let suite = this.getSuite(this.suiteUid);

    for (let i = 0; i < suite.tests.length; i++) {
      if (uid === suite.tests[i].uid) {
        return suite.tests[i];
      }
    }

    return null;
  } //this is a hack.  we have to move all the things in test.errors before they get blown away


  moveErrorsToEvents(test) {
    if (test.errors) {
      for (let i = test.errorIndex; i < test.errors.length; i++) {
        test.events.push({
          type: 'Error',
          ...test.errors[i]
        });
      }

      test.errorIndex = test.errors.length;
    }
  }

  saveScreenshot(filepath) {
    let test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'screenshot',
      value: filepath
    });
  }

  saveMessage(message) {
    const test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'log',
      value: message
    });
  }

  getOrderedSuites() {
    if (this.orderedSuites) {
      return this.orderedSuites;
    }

    this.orderedSuites = [];

    for (const uid of this.suiteUids) {
      for (const suite of this.suites) {
        if (suite.uid !== uid) {
          continue;
        }

        this.orderedSuites.push(suite);
      }
    }

    return this.orderedSuites;
  } // convert to a style class


  indent(uid) {
    const indents = this.suiteIndents[uid];
    return indents === 0 ? '' : Array(indents).join('    ');
  }

  onRunnerEnd(runner) {
    let self = this;
    this.log("onRunnerEnd: ", JSON.stringify(runner));
    self.openInProgress = true;
    self.metrics.start = runner.start;
    self.metrics.end = runner.end;
    self.metrics.duration = runner._duration;

    if (!self.suiteUid) {
      self.suiteUid = "suite";
    }

    if (!self.cid) {
      self.cid = "cid";
    }

    const reportOptions = {
      data: {
        info: runner,
        metrics: self.metrics,
        suites: self.getOrderedSuites(),
        title: self.options.reportTitle
      },
      showInBrowser: self.options.showInBrowser,
      collapseTests: self.options.collapseTests,
      outputDir: self.options.outputDir,
      reportFile: path.join(process.cwd(), self.options.outputDir, encodeURIComponent(self.suiteUid), encodeURIComponent(self.cid), self.options.filename),
      templateFilename: self.options.templateFilename,
      templateFuncs: self.options.templateFuncs
    };

    _htmlGenerator.default.htmlOutput(reportOptions, () => {
      self.openInProgress = false;
    });
  }

}

var _default = HtmlReporter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRlci5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJfIiwicGF0aCIsIm1vbWVudCIsIm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAiLCJsb2c0anMiLCJsb2dnZXIiLCJnZXRMb2dnZXIiLCJSZXBvcnRFdmVudHMiLCJwcm94eSIsImRlZmF1bHQiLCJIdG1sUmVwb3J0ZXIiLCJXRElPUmVwb3J0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJzdGRvdXQiLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidGVtcGxhdGVGdW5jcyIsInJlcG9ydFRpdGxlIiwic2hvd0luQnJvd3NlciIsImNvbGxhcHNlVGVzdHMiLCJ1c2VPbkFmdGVyQ29tbWFuZEZvclNjcmVlbnNob3QiLCJsb2dGaWxlIiwiTE9HIiwib3B0aW9ucyIsImRpciIsImVuc3VyZURpclN5bmMiLCJzdWl0ZVVpZHMiLCJzdWl0ZXMiLCJpbmRlbnRzIiwic3VpdGVJbmRlbnRzIiwibWV0cmljcyIsInBhc3NlZCIsInNraXBwZWQiLCJmYWlsZWQiLCJzdGFydCIsImVuZCIsImR1cmF0aW9uIiwib3BlbkluUHJvZ3Jlc3MiLCJkZWZhdWx0VGVzdEluZGVudCIsImNvbm5lY3RNZXNzYWdlRXZlbnQiLCJzYXZlTWVzc2FnZSIsImJpbmQiLCJjb25uZWN0U2NyZWVuc2hvdEV2ZW50Iiwic2F2ZVNjcmVlbnNob3QiLCJpc1N5bmNocm9uaXNlZCIsIm9uUnVubmVyU3RhcnQiLCJydW5uZXIiLCJsb2ciLCJKU09OIiwic3RyaW5naWZ5IiwiY2lkIiwib25TdWl0ZVN0YXJ0Iiwic3VpdGUiLCJwdXNoIiwidWlkIiwic3VpdGVVaWQiLCJ0aGlzU3VpdGUiLCJ0eXBlIiwib25UZXN0U3RhcnQiLCJ0aGVUZXN0IiwidGVzdFVpZCIsInRlc3QiLCJnZXRUZXN0IiwiZXZlbnRzIiwiZXJyb3JJbmRleCIsIm9uVGVzdFBhc3MiLCJvblRlc3RTa2lwIiwib25UZXN0RmFpbCIsIm1vdmVFcnJvcnNUb0V2ZW50cyIsIm9uSG9va0VuZCIsImhvb2siLCJlcnJvciIsIm9uVGVzdEVuZCIsIm9uU3VpdGVFbmQiLCJ0c3VpdGUiLCJfZHVyYXRpb24iLCJpc1NjcmVlbnNob3RDb21tYW5kIiwiY29tbWFuZCIsImlzU2NyZWVuc2hvdEVuZHBvaW50IiwiZW5kcG9pbnQiLCJvbkFmdGVyQ29tbWFuZCIsInJlc3VsdCIsInZhbHVlIiwidGltZXN0YW1wIiwiZm9ybWF0IiwiZmlsZXBhdGgiLCJqb2luIiwiZW5jb2RlVVJJQ29tcG9uZW50Iiwib3V0cHV0RmlsZVN5bmMiLCJCdWZmZXIiLCJmcm9tIiwibWVzc2FnZSIsIm9iamVjdCIsImRlYnVnIiwiZ2V0U3VpdGUiLCJpIiwibGVuZ3RoIiwidGVzdHMiLCJlcnJvcnMiLCJnZXRPcmRlcmVkU3VpdGVzIiwib3JkZXJlZFN1aXRlcyIsImluZGVudCIsIkFycmF5Iiwib25SdW5uZXJFbmQiLCJzZWxmIiwicmVwb3J0T3B0aW9ucyIsImRhdGEiLCJpbmZvIiwidGl0bGUiLCJyZXBvcnRGaWxlIiwicHJvY2VzcyIsImN3ZCIsIkh0bWxHZW5lcmF0b3IiLCJodG1sT3V0cHV0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBbEI7O0FBQ0EsTUFBTUMsQ0FBQyxHQUFHRCxPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLE1BQU1HLE1BQU0sR0FBR0gsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBQ0EsTUFBTUkseUJBQXlCLEdBQUdKLE9BQU8sQ0FBQyx3QkFBRCxDQUF6Qzs7QUFDQUkseUJBQXlCLENBQUNELE1BQUQsQ0FBekI7O0FBQ0EsTUFBTUUsTUFBTSxHQUFHTCxPQUFPLENBQUMseUJBQUQs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cG9ydGVyIGZyb20gJ0B3ZGlvL3JlcG9ydGVyJ1xyXG5pbXBvcnQgSHRtbEdlbmVyYXRvciBmcm9tICcuL2h0bWxHZW5lcmF0b3InXHJcblxyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XHJcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcbmNvbnN0IG1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAgPSByZXF1aXJlKFwibW9tZW50LWR1cmF0aW9uLWZvcm1hdFwiKTtcclxubW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cChtb21lbnQpO1xyXG5jb25zdCBsb2c0anMgPSByZXF1aXJlKCdAbG9nNGpzLW5vZGUvbG9nNGpzLWFwaScpO1xyXG5jb25zdCBsb2dnZXIgPSBsb2c0anMuZ2V0TG9nZ2VyKCdkZWZhdWx0Jyk7XHJcbmNvbnN0IFJlcG9ydEV2ZW50cyAgPSByZXF1aXJlKFwiQHJwaWkvd2Rpby1yZXBvcnQtZXZlbnRzXCIpIDtcclxubGV0IHByb3h5ID0gbmV3IFJlcG9ydEV2ZW50cy5kZWZhdWx0KCkgO1xyXG5cclxuY2xhc3MgSHRtbFJlcG9ydGVyIGV4dGVuZHMgV0RJT1JlcG9ydGVyIHtcclxuXHJcblxyXG4gICAgY29uc3RydWN0b3Iob3B0cykge1xyXG4gICAgICAgIG9wdHMgPSBPYmplY3QuYXNzaWduKHt9LCB7XHJcbiAgICAgICAgICAgIHN0ZG91dDogdHJ1ZSxcclxuICAgICAgICAgICAgb3V0cHV0RGlyOiAncmVwb3J0cy9odG1sLXJlcG9ydHMvJyxcclxuICAgICAgICAgICAgZmlsZW5hbWU6ICdyZXBvcnQuaHRtbCcsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlRmlsZW5hbWU6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi90ZW1wbGF0ZXMvd2Rpby1odG1sLXJlcG9ydGVyLXRlbXBsYXRlLmhicycpLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZ1bmNzOiB7fSxcclxuICAgICAgICAgICAgcmVwb3J0VGl0bGU6ICdUZXN0IFJlcG9ydCBUaXRsZScsXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXI6IGZhbHNlLFxyXG4gICAgICAgICAgICBjb2xsYXBzZVRlc3RzOiBmYWxzZSxcclxuICAgICAgICAgICAgdXNlT25BZnRlckNvbW1hbmRGb3JTY3JlZW5zaG90OiB0cnVlLFxyXG4gICAgICAgICAgICBsb2dGaWxlOiBcImxvZ3MvcmVwb3J0ZXIubG9nXCIsXHJcbiAgICAgICAgICAgIExPRyA6IG51bGxcclxuICAgICAgICB9LCBvcHRzKTtcclxuICAgICAgICBzdXBlcihvcHRzKTtcclxuICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRzO1xyXG4gICAgICAgIGlmICghdGhpcy5vcHRpb25zLkxPRykge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMuTE9HID0gbG9nZ2VyO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkaXIgPSB0aGlzLm9wdGlvbnMub3V0cHV0RGlyICsgJ3NjcmVlbnNob3RzJyA7XHJcblxyXG4gICAgICAgIGZzLmVuc3VyZURpclN5bmMoZGlyKSA7XHJcbiAgICAgICAgdGhpcy5zdWl0ZVVpZHMgPSBbXTtcclxuICAgICAgICB0aGlzLnN1aXRlcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuaW5kZW50cyA9IDA7XHJcbiAgICAgICAgdGhpcy5zdWl0ZUluZGVudHMgPSB7fTtcclxuICAgICAgICB0aGlzLm1ldHJpY3MgPSB7XHJcbiAgICAgICAgICAgIHBhc3NlZCA6IDAsXHJcbiAgICAgICAgICAgIHNraXBwZWQgOiAwLFxyXG4gICAgICAgICAgICBmYWlsZWQgOiAwLFxyXG4gICAgICAgICAgICBzdGFydDogMCxcclxuICAgICAgICAgICAgZW5kOiAwICxcclxuICAgICAgICAgICAgZHVyYXRpb246MFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5vcGVuSW5Qcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuZGVmYXVsdFRlc3RJbmRlbnQgPSAnICAgJyA7XHJcbiAgICAgICAgcHJveHkuY29ubmVjdE1lc3NhZ2VFdmVudCh0aGlzLnNhdmVNZXNzYWdlLmJpbmQodGhpcykpO1xyXG4gICAgICAgIHByb3h5LmNvbm5lY3RTY3JlZW5zaG90RXZlbnQodGhpcy5zYXZlU2NyZWVuc2hvdC5iaW5kKHRoaXMpKTtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGlzU3luY2hyb25pc2VkICgpIHtcclxuICAgICAgICByZXR1cm4gIXRoaXMub3BlbkluUHJvZ3Jlc3MgO1xyXG4gICAgfVxyXG5cclxuICAgIG9uUnVubmVyU3RhcnQocnVubmVyKSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblJ1bm5lclN0YXJ0OiBcIiAsIEpTT04uc3RyaW5naWZ5KHJ1bm5lcikpO1xyXG4gICAgICAgIC8vdG9kbyBsb29rIGF0IGZpeCwgbm90IGFzeW5jIHNhZmUuIGJ1dCBvbmUgY2lkIHBlciByZXBvcnQgZmlsZVxyXG4gICAgICAgIHRoaXMuY2lkID0gcnVubmVyLmNpZDtcclxuICAgICAgICB0aGlzLm1ldHJpY3MucGFzc2VkID0gMDtcclxuICAgICAgICB0aGlzLm1ldHJpY3Muc2tpcHBlZCA9IDA7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLmZhaWxlZCA9IDA7XHJcbiAgICB9XHJcblxyXG4gICAgb25TdWl0ZVN0YXJ0KHN1aXRlKSB7XHJcbiAgICAgICAgdGhpcy5zdWl0ZVVpZHMucHVzaChzdWl0ZS51aWQpO1xyXG4gICAgICAgIHRoaXMuc3VpdGVJbmRlbnRzW3N1aXRlLnVpZF0gPSArK3RoaXMuaW5kZW50cztcclxuICAgICAgICB0aGlzLnN1aXRlVWlkID0gc3VpdGUudWlkO1xyXG4gICAgICAgIGxldCB0aGlzU3VpdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzdWl0ZSk7XHJcbiAgICAgICAgdGhpc1N1aXRlLnR5cGUgPSAnc3VpdGUnO1xyXG4gICAgICAgIHRoaXMuc3VpdGVzLnB1c2godGhpc1N1aXRlKTtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uU3VpdGVTdGFydDogXCIsIEpTT04uc3RyaW5naWZ5KHRoaXNTdWl0ZSkpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdFN0YXJ0KHRoZVRlc3QpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uVGVzdFN0YXJ0OiBcIiAsIEpTT04uc3RyaW5naWZ5KHRoZVRlc3QpKTtcclxuICAgICAgICB0aGlzLnRlc3RVaWQgPSB0aGVUZXN0LnVpZCA7XHJcbiAgICAgICAgbGV0IHRlc3QgPSB0aGlzLmdldFRlc3QodGhlVGVzdC51aWQpIDtcclxuICAgICAgICB0ZXN0LmV2ZW50cyA9IFtdO1xyXG4gICAgICAgIHRlc3QuZXJyb3JJbmRleCA9IDAgO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdFBhc3ModGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0UGFzczogXCIgLCBKU09OLnN0cmluZ2lmeSh0ZXN0KSk7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLnBhc3NlZCsrO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdFNraXAodGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0U2tpcDogXCIgLCBKU09OLnN0cmluZ2lmeSh0ZXN0KSk7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLnNraXBwZWQrKztcclxuICAgIH1cclxuXHJcbiAgICBvblRlc3RGYWlsKHRlc3QpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uVGVzdEZhaWw6IFwiICwgSlNPTi5zdHJpbmdpZnkodGVzdCkpO1xyXG4gICAgICAgIHRoaXMubW92ZUVycm9yc1RvRXZlbnRzKHRlc3QpO1xyXG4gICAgICAgIHRoaXMubWV0cmljcy5mYWlsZWQrKztcclxuICAgIH1cclxuXHJcbiAgICBvbkhvb2tFbmQoaG9vaykge1xyXG4gICAgICAgIGlmIChob29rLmVycm9yKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWV0cmljcy5mYWlsZWQrKztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBvblRlc3RFbmQodGhlVGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0RW5kOiBcIiAsIEpTT04uc3RyaW5naWZ5KHRoZVRlc3QpKTtcclxuICAgICAgICBsZXQgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGVUZXN0LnVpZCkgO1xyXG4gICAgICAgIHRoaXMubW92ZUVycm9yc1RvRXZlbnRzKHRlc3QpIDtcclxuICAgIH1cclxuXHJcbiAgICBvblN1aXRlRW5kKHN1aXRlKSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblN1aXRlRW5kOiBcIiAsIEpTT04uc3RyaW5naWZ5KHN1aXRlKSk7XHJcbiAgICAgICAgdGhpcy5pbmRlbnRzLS07XHJcbiAgICAgICAgLy8gdGhpcyBpcyB0byBkaXNwbGF5IHN1aXRlIGVuZCB0aW1lIGFuZCBkdXJhdGlvbiBpbiBtYXN0ZXIgcmVwb3J0LlxyXG4gICAgICAgIGZvciAoY29uc3QgdHN1aXRlIG9mIHRoaXMuc3VpdGVzKSB7XHJcbiAgICAgICAgICAgIGlmICh0c3VpdGUudWlkID09IHN1aXRlLnVpZCkge1xyXG4gICAgICAgICAgICAgICAgdHN1aXRlLmVuZCA9IHN1aXRlLmVuZDtcclxuICAgICAgICAgICAgICAgIHRzdWl0ZS5fZHVyYXRpb24gPSBzdWl0ZS5fZHVyYXRpb247XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpc1NjcmVlbnNob3RDb21tYW5kKGNvbW1hbmQpIHtcclxuICAgICAgICBjb25zdCBpc1NjcmVlbnNob3RFbmRwb2ludCA9IC9cXC9zZXNzaW9uXFwvW14vXSpcXC9zY3JlZW5zaG90L1xyXG4gICAgICAgIHJldHVybiBpc1NjcmVlbnNob3RFbmRwb2ludC50ZXN0KGNvbW1hbmQuZW5kcG9pbnQpXHJcbiAgICB9XHJcblxyXG4gICAgLy90aGlzIGlzIGEgaGFjayB0byBnZXQgYXJvdW5kIGxhY2sgb2Ygb25TY3JlZW5zaG90IGV2ZW50XHJcbiAgICBvbkFmdGVyQ29tbWFuZChjb21tYW5kKSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy51c2VPbkFmdGVyQ29tbWFuZEZvclNjcmVlbnNob3QpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNTY3JlZW5zaG90Q29tbWFuZChjb21tYW5kKSAmJiBjb21tYW5kLnJlc3VsdC52YWx1ZSkge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IG1vbWVudCgpLmZvcm1hdCgnWVlZWU1NREQtSEhtbXNzLlNTUycpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZXBhdGggPSBwYXRoLmpvaW4odGhpcy5vcHRpb25zLm91dHB1dERpciwgJy9zY3JlZW5zaG90cy8nLCBlbmNvZGVVUklDb21wb25lbnQodGhpcy5jaWQpLCB0aW1lc3RhbXAsIHRoaXMub3B0aW9ucy5maWxlbmFtZSArICcucG5nJyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZyhcIm9uQWZ0ZXJDb21tYW5kOiB0YWtpbmcgc2NyZWVuc2hvdCBcIiArIGZpbGVwYXRoKTtcclxuICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKGZpbGVwYXRoLCBCdWZmZXIuZnJvbShjb21tYW5kLnJlc3VsdC52YWx1ZSwgJ2Jhc2U2NCcpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGlzLnRlc3RVaWQpO1xyXG4gICAgICAgICAgICAgICAgdGVzdC5ldmVudHMucHVzaCh7dHlwZTogJ3NjcmVlbnNob3QnLCB2YWx1ZTogZmlsZXBhdGh9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsb2cobWVzc2FnZSxvYmplY3QpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLkxPRyB8fCB0aGlzLm9wdGlvbnMuZGVidWcgKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5MT0cuZGVidWcobWVzc2FnZSArIG9iamVjdCkgO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGdldFN1aXRlKHVpZCkge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IHRoaXMuc3VpdGVzLmxlbmd0aCA7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAodWlkID09PSB0aGlzLnN1aXRlc1tpXS51aWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN1aXRlc1tpXSA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VGVzdCh1aWQpIHtcclxuICAgICAgICBsZXQgc3VpdGUgPSB0aGlzLmdldFN1aXRlKHRoaXMuc3VpdGVVaWQpO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IHN1aXRlLnRlc3RzLmxlbmd0aCA7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAodWlkID09PSBzdWl0ZS50ZXN0c1tpXS51aWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzdWl0ZS50ZXN0c1tpXSA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgLy90aGlzIGlzIGEgaGFjay4gIHdlIGhhdmUgdG8gbW92ZSBhbGwgdGhlIHRoaW5ncyBpbiB0ZXN0LmVycm9ycyBiZWZvcmUgdGhleSBnZXQgYmxvd24gYXdheVxyXG5cclxuICAgIG1vdmVFcnJvcnNUb0V2ZW50cyh0ZXN0KSB7XHJcbiAgICAgICAgaWYgKHRlc3QuZXJyb3JzKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0ZXN0LmVycm9ySW5kZXg7IGkgPCB0ZXN0LmVycm9ycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdGVzdC5ldmVudHMucHVzaCh7dHlwZTogJ0Vycm9yJywgLi4udGVzdC5lcnJvcnNbaV19KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0ZXN0LmVycm9ySW5kZXggPSB0ZXN0LmVycm9ycy5sZW5ndGg7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNhdmVTY3JlZW5zaG90KGZpbGVwYXRoKSB7XHJcbiAgICAgICAgbGV0IHRlc3QgPSB0aGlzLmdldFRlc3QodGhpcy50ZXN0VWlkKSA7XHJcbiAgICAgICAgdGhpcy5tb3ZlRXJyb3JzVG9FdmVudHModGVzdCkgO1xyXG4gICAgICAgIHRlc3QuZXZlbnRzLnB1c2goe3R5cGU6ICdzY3JlZW5zaG90JywgdmFsdWU6IGZpbGVwYXRofSkgO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVNZXNzYWdlKG1lc3NhZ2UpIHtcclxuICAgICAgICBjb25zdCB0ZXN0ID0gdGhpcy5nZXRUZXN0KHRoaXMudGVzdFVpZCk7XHJcbiAgICAgICAgdGhpcy5tb3ZlRXJyb3JzVG9FdmVudHModGVzdCkgO1xyXG4gICAgICAgIHRlc3QuZXZlbnRzLnB1c2goe3R5cGU6ICdsb2cnLCB2YWx1ZTogbWVzc2FnZX0pIDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgZ2V0T3JkZXJlZFN1aXRlcygpIHtcclxuICAgICAgICBpZiAodGhpcy5vcmRlcmVkU3VpdGVzKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9yZGVyZWRTdWl0ZXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLm9yZGVyZWRTdWl0ZXMgPSBbXTtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCB1aWQgb2YgdGhpcy5zdWl0ZVVpZHMpIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBzdWl0ZSBvZiB0aGlzLnN1aXRlcykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN1aXRlLnVpZCAhPT0gdWlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5vcmRlcmVkU3VpdGVzLnB1c2goc3VpdGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5vcmRlcmVkU3VpdGVzO1xyXG4gICAgfVxyXG5cclxuLy8gY29udmVydCB0byBhIHN0eWxlIGNsYXNzXHJcbiAgICBpbmRlbnQodWlkKSB7XHJcbiAgICAgICAgY29uc3QgaW5kZW50cyA9IHRoaXMuc3VpdGVJbmRlbnRzW3VpZF07XHJcbiAgICAgICAgcmV0dXJuIGluZGVudHMgPT09IDAgPyAnJyA6IEFycmF5KGluZGVudHMpLmpvaW4oJyAgICAnKTtcclxuICAgIH1cclxuXHJcbiAgICBvblJ1bm5lckVuZChydW5uZXIpIHtcclxuICAgICAgICBsZXQgc2VsZiA9IHRoaXMgO1xyXG4gICAgICAgIHRoaXMubG9nKFwib25SdW5uZXJFbmQ6IFwiICwgSlNPTi5zdHJpbmdpZnkocnVubmVyKSk7XHJcbiAgICAgICAgc2VsZi5vcGVuSW5Qcm9ncmVzcyA9IHRydWU7XHJcbiAgICAgICAgc2VsZi5tZXRyaWNzLnN0YXJ0ID0gcnVubmVyLnN0YXJ0IDtcclxuICAgICAgICBzZWxmLm1ldHJpY3MuZW5kID0gcnVubmVyLmVuZCA7XHJcbiAgICAgICAgc2VsZi5tZXRyaWNzLmR1cmF0aW9uID0gcnVubmVyLl9kdXJhdGlvbjtcclxuICAgICAgICBpZiAoISBzZWxmLnN1aXRlVWlkKSB7XHJcbiAgICAgICAgICAgIHNlbGYuc3VpdGVVaWQgPSBcInN1aXRlXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghIHNlbGYuY2lkKSB7XHJcbiAgICAgICAgICAgIHNlbGYuY2lkID0gXCJjaWRcIiA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJlcG9ydE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGRhdGEgOiB7XHJcbiAgICAgICAgICAgICAgICBpbmZvOiBydW5uZXIsXHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzOiBzZWxmLm1ldHJpY3MsXHJcbiAgICAgICAgICAgICAgICBzdWl0ZXM6IHNlbGYuZ2V0T3JkZXJlZFN1aXRlcygpLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6IHNlbGYub3B0aW9ucy5yZXBvcnRUaXRsZVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzaG93SW5Ccm93c2VyIDogc2VsZi5vcHRpb25zLnNob3dJbkJyb3dzZXIsXHJcbiAgICAgICAgICAgIGNvbGxhcHNlVGVzdHMgOiBzZWxmLm9wdGlvbnMuY29sbGFwc2VUZXN0cyxcclxuICAgICAgICAgICAgb3V0cHV0RGlyIDogc2VsZi5vcHRpb25zLm91dHB1dERpcixcclxuICAgICAgICAgICAgcmVwb3J0RmlsZSA6IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBzZWxmLm9wdGlvbnMub3V0cHV0RGlyLCBlbmNvZGVVUklDb21wb25lbnQoc2VsZi5zdWl0ZVVpZCkgLCBlbmNvZGVVUklDb21wb25lbnQoc2VsZi5jaWQpLCBzZWxmLm9wdGlvbnMuZmlsZW5hbWUpLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiBzZWxmLm9wdGlvbnMudGVtcGxhdGVGaWxlbmFtZSxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczogc2VsZi5vcHRpb25zLnRlbXBsYXRlRnVuY3MsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBIdG1sR2VuZXJhdG9yLmh0bWxPdXRwdXQocmVwb3J0T3B0aW9ucywoKSA9PiB7XHJcbiAgICAgICAgICAgIHNlbGYub3BlbkluUHJvZ3Jlc3MgPSBmYWxzZSAgO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBIdG1sUmVwb3J0ZXI7XHJcbiJdfQ==